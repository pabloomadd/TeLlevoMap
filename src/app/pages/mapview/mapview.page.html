<div class="map-container">
  <mgl-map
    [style]="'mapbox://styles/mapbox/streets-v12'"
    [zoom]="[15.5]"
    [center]="centro"
    [pitch]="[45]"
    [bearing]="[-17.6]"
    (mapLoad)="onLoad($event.target)"
  >
    <mgl-layer
      id="3d-buildings"
      source="composite"
      sourceLayer="building"
      [filter]="['==', 'extrude', 'true']"
      type="fill-extrusion"
      [minzoom]="15"
      [paint]="{
      'fill-extrusion-color': '#aaa',
      'fill-extrusion-height': [
        'interpolate',
        ['linear'],
        ['zoom'],
        15,
        0,
        15.05,
        ['get', 'height']
      ],
      'fill-extrusion-base': [
        'interpolate',
        ['linear'],
        ['zoom'],
        15,
        0,
        15.05,
        ['get', 'min_height']
      ],
      'fill-extrusion-opacity': 0.6
    }"
      [before]="labelLayerId"
    ></mgl-layer>

    <!-- GPS Marker -->
    @if (gps) {
    <mgl-marker [lngLat]="gps">
      <ion-img src="assets/icons/gps.svg" class="gpsMarker"></ion-img>
    </mgl-marker>
    }

    <!-- Init&End Marker -->
    @if (inicio) {
    <mgl-marker [lngLat]="inicio">
      <ion-img src="assets/icons/geo.svg" class="initMarker"></ion-img>
    </mgl-marker>
    } @if (destino) {
    <mgl-marker [lngLat]="destino">
      <ion-img src="assets/icons/geo.svg" class="endMarker"></ion-img>
    </mgl-marker>
    } @if (routeSource) {
    <mgl-layer
      [id]="'routerLayer'"
      [type]="'line'"
      [source]="routeSource"
      [paint]="routePaint"
    >
    </mgl-layer>
    }
  </mgl-map>

  <ion-button class="gpsBtn" shape="round" (click)="getGPS()">
    <ion-icon slot="icon-only" src="assets/icons/crosshair.svg"></ion-icon>
  </ion-button>

  <ion-card class="main">
    <ion-card-header>
      <ion-card-title>Viajes</ion-card-title>
    </ion-card-header>

    @if(isViajeActivo){
    <ion-card class="viajeCard">
      <ion-card-subtitle>Viaje Activo</ion-card-subtitle>

      <ion-card-content>
        <ion-row>
          <ion-col size="8">
            <h6>Nombre: Viaje de Malitos</h6>
            <p>Desde:Vi√±a</p>
            <p>Hasta:Valparaiso</p>
          </ion-col>
          <ion-col size="4">
            <ion-button>
              <ion-icon src="assets/icons/search.svg"></ion-icon>
            </ion-button>
            <ion-button>
              <ion-icon src="assets/icons/search.svg"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>
    }@else {
    <ion-content class="tripScroll">
      @for (viaje of viajes; track $index){
      <ion-card
        class="viajeCard"
        [ngClass]="{'selectedCard':selectedTripId === $index}"
      >
        <ion-row>
          <ion-col size="8">
            <h6 class="tripTitle">{{viaje.nombre}}</h6>

            <p class="txtWIcon">
              <ion-img
                class="txtIco initMarker"
                src="assets/icons/geo.svg"
              ></ion-img>
              Desde: {{viaje.start.name}}
            </p>

            <p class="txtWIcon">
              <ion-img
                class="txtIco endMarker"
                src="assets/icons/geo.svg"
              ></ion-img>
              Hasta: {{viaje.end.name}}
            </p>
          </ion-col>
          <ion-col size="4" class="ion-margin-top">
            <!-- Boton ViewRoute -->
            <ion-button
              color="tertiary"
              (click)="viewRouteBtn(viaje.start.longitude, viaje.start.latitude, viaje.end.longitude, viaje.end.latitude, $index)"
            >
              <ion-icon src="assets/icons/search.svg"></ion-icon>
            </ion-button>

            <!-- Boton Unirse -->
            <ion-button color="success" id="tripModal{{$index}}">
              <ion-icon src="assets/icons/join.svg"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>

        <ion-modal #modal trigger="tripModal{{$index}}">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Detalles del Viaje</ion-title>
                <ion-buttons slot="end">
                  <ion-button (click)="modal.dismiss()"> Cerrar </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content>
              <!-- Info Viaje -->
              <div class="seatContainer">
                <!-- Fondo CarRef -->
                <ion-img src="assets/imgs/cartop.png" class="seatRef"></ion-img>

                <ion-card class="tripDetCard">
                  <p>
                    <span><ion-text color="medium">Nombre:</ion-text></span>
                    {{viaje.nombre}}
                  </p>
                  <p>
                    <span><ion-text color="medium">Desde:</ion-text></span>
                    {{viaje.start.name}}
                  </p>
                  <p>
                    <span><ion-text color="medium">Hasta:</ion-text></span>
                    {{viaje.end.name}}
                  </p>
                  <p>
                    <span><ion-text color="medium">Conductor:</ion-text></span>
                    {{viaje.driver}}
                  </p>
                </ion-card>

                <!-- Asientos -->
                <div class="seatContent">
                  <h6>- Asientos -</h6>
                  <ion-text color="medium">
                    <p>Seleccione uno para unirse al viaje</p>
                  </ion-text>
                  <div class="seatBtn">
                    <ion-row>
                      <ion-col size="12">
                        <ion-button
                          shape="round"
                          disabled="true"
                          class="ion-padding"
                        >
                          Conductor
                        </ion-button>
                        <ion-button class="ion-padding" color="tertiary" (click)="joinToTrip(viaje.id,1,user.id)" [disabled]='viaje.seat1'>
                          1
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </div>
                  <div class="seatBtn">
                    <ion-row>
                      <ion-col size="12">
                        <ion-button class="ion-padding" color="tertiary" (click)="joinToTrip(viaje.id,2,user.id)"  [disabled]="viaje.seat2">
                          2
                        </ion-button>
                        <ion-button class="ion-padding" color="tertiary" (click)="joinToTrip(viaje.id,3,user.id)"  [disabled]="viaje.seat3">
                          3
                        </ion-button>
                        <ion-button class="ion-padding" color="tertiary" (click)="joinToTrip(viaje.id,4,user.id)"  [disabled]="viaje.seat4">
                          4
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </div>
                </div>
              </div>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-card>

      }
    </ion-content>
    }
  </ion-card>
</div>
